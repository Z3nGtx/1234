#include <stdio.h>
#include <pthread.h>
#include <semaphore.h>
#include <unistd.h>

// Shared resource
int data = 0;

// Counters and synchronization tools
int read_count = 0;
sem_t wrt;              // semaphore for writers
pthread_mutex_t mutex;  // mutex for readers count control

// Reader function
void* reader(void* arg) {
    int id = *(int*)arg;

    // Entry section
    pthread_mutex_lock(&mutex);
    read_count++;
    if (read_count == 1)
        sem_wait(&wrt); // first reader locks the writer
    pthread_mutex_unlock(&mutex);

    // Critical section (Reading)
    printf("üëì Reader %d is reading the data: %d\n", id, data);
    sleep(1);

    // Exit section
    pthread_mutex_lock(&mutex);
    read_count--;
    if (read_count == 0)
        sem_post(&wrt); // last reader unlocks the writer
    pthread_mutex_unlock(&mutex);

    return NULL;
}

// Writer function
void* writer(void* arg) {
    int id = *(int*)arg;

    sem_wait(&wrt); // writer wants to access shared data
    data++;
    printf("‚úçÔ∏è Writer %d updated the data to: %d\n", id, data);
    sleep(1);
    sem_post(&wrt); // release the shared resource

    return NULL;
}

int main() {
    pthread_t rtid[5], wtid[3];
    int rid[5] = {1, 2, 3, 4, 5};
    int wid[3] = {1, 2, 3};

    // Initialize semaphore and mutex
    sem_init(&wrt, 0, 1);
    pthread_mutex_init(&mutex, NULL);

    // Create reader and writer threads
    pthread_create(&wtid[0], NULL, writer, &wid[0]);
    pthread_create(&rtid[0], NULL, reader, &rid[0]);
    pthread_create(&rtid[1], NULL, reader, &rid[1]);
    pthread_create(&wtid[1], NULL, writer, &wid[1]);
    pthread_create(&rtid[2], NULL, reader, &rid[2]);
    pthread_create(&wtid[2], NULL, writer, &wid[2]);

    // Wait for all threads to complete
    for (int i = 0; i < 5; i++)
        pthread_join(rtid[i], NULL);
    for (int i = 0; i < 3; i++)
        pthread_join(wtid[i], NULL);

    // Destroy semaphore and mutex
    sem_destroy(&wrt);
    pthread_mutex_destroy(&mutex);

    return 0;
}
